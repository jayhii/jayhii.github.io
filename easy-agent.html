<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>LangGraph ë…¸ë“œ ì—ë””í„°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/drawflow/dist/drawflow.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css">
  
  <style>
    :root {
      --primary-color: #2196F3;
      --primary-dark: #1565C0;
      --secondary-color: #4CAF50;
      --secondary-dark: #388E3C;
      --background-light: #f5f5f5;
      --border-color: #ccc;
      --shadow-color: rgba(0, 0, 0, 0.1);
    }

    html, body { 
      margin: 0; 
      padding: 0; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .main-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    /* í—¤ë” ìŠ¤íƒ€ì¼ */
    header {
      background-color: var(--primary-color);
      color: white;
      padding: 0.8rem 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 100;
    }
    
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      text-decoration: none;
      color: white;
      display: flex;
      align-items: center;
    }
    
    .logo-icon {
      margin-right: 10px;
      font-size: 1.8rem;
    }
    
    .page-title {
      font-size: 1.4rem;
      font-weight: 500;
    }
    
    .nav-buttons {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    
    .nav-button {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background-color 0.3s;
      text-decoration: none;
      display: flex;
      align-items: center;
    }
    
    .nav-button:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    .nav-button i {
      margin-right: 5px;
    }
    
    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: white;
      font-size: 0.9rem;
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: #fff;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    /* ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì»¨í…Œì´ë„ˆ */
    .workspace-container { 
      display: flex; 
      flex: 1;
      height: calc(100vh - 128px); /* í—¤ë”ì™€ í‘¸í„° ë†’ì´ ì œì™¸ */
      width: 100vw; 
    }
    
    /* ì‚¬ì´ë“œë°” */
    .sidebar {
      width: 240px;
      background: var(--background-light);
      border-right: 1px solid var(--border-color);
      padding: 1rem;
      overflow-y: auto;
      box-shadow: 2px 0 5px var(--shadow-color);
      z-index: 10;
    }
    
    .sidebar h3 {
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .sidebar button {
      width: 100%;
      padding: 1rem;
      margin-bottom: 12px;
      font-size: 1.1rem;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .sidebar button:hover {
      background: #e9f5ff;
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--shadow-color);
    }
    
    .sidebar button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px var(--shadow-color);
    }
    
    .sidebar button::after {
      content: "+";
      font-size: 1.2rem;
      color: var(--primary-color);
    }

    /* ì—ë””í„° ì˜ì—­ */
    .editor-container {
      flex: 2;
      position: relative;
      display: flex;
      background-color: #fafafa;
    }
    
    .editor-background {
      width: 100%;
      height: 100%;
      background-image: radial-gradient(#ddd 1px, transparent 1px);
      background-size: 20px 20px;
    }

    /* ì½”ë“œ ë·°ì–´ */
    .code-viewer {
      width: 30%;
      background: #fff;
      border-left: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      box-shadow: -2px 0 5px var(--shadow-color);
    }
    
    .code-viewer-content, .code-viewer-edit {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }
    
    .code-viewer-edit {
      background: #fff;
      border-top: 1px solid var(--border-color);
    }
    
    .code-viewer-edit h4 { 
      margin-top: 0; 
      color: var(--primary-dark);
    }
    
    .code-viewer-edit label {
      display: block;
      margin-top: 12px;
      font-weight: 500;
    }
    
    .code-viewer-edit input, .code-viewer-edit textarea {
      width: 100%;
      margin-top: 5px;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-family: inherit;
    }
    
    .code-viewer-edit textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .code-viewer-edit input:focus, .code-viewer-edit textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
    }
    
    .code-viewer-edit button {
      margin-top: 15px;
      padding: 8px 12px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .code-viewer-edit button:hover {
      background-color: var(--primary-dark);
    }
    
    .code-viewer-content h3 {
      margin-top: 0;
      color: var(--primary-dark);
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .code-viewer-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .code-viewer-actions button {
      flex: 1;
      padding: 8px 12px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .code-viewer-actions button:hover {
      background-color: var(--primary-dark);
    }
    
    .code-viewer-actions button.secondary {
      background-color: #f5f5f5;
      color: #333;
      border: 1px solid var(--border-color);
    }
    
    .code-viewer-actions button.secondary:hover {
      background-color: #e0e0e0;
    }
    
    pre {
      background: #f8f8f8;
      padding: 1rem;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      white-space: pre-wrap;
      overflow-x: auto;
      margin: 0;
    }

    /* ë…¸ë“œ ìŠ¤íƒ€ì¼ */
    .drawflow .drawflow-node {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 2px 10px var(--shadow-color);
      padding: 10px 15px;
      transition: box-shadow 0.3s, transform 0.3s;
    }
    
    .drawflow .drawflow-node:hover {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }
    
    .drawflow .drawflow-node.selected {
      border: 2px solid var(--primary-color);
      box-shadow: 0 0 0 4px rgba(33, 150, 243, 0.2);
    }
    
    .drawflow .drawflow-node .title-box {
      padding-bottom: 5px;
      margin-bottom: 5px;
      border-bottom: 1px solid var(--border-color);
      font-weight: bold;
      color: var(--primary-dark);
    }
    
    .drawflow .drawflow-node .description-box {
      font-size: 0.9rem;
      color: #666;
    }

    /* íŠ¹ìˆ˜ ë…¸ë“œ ìŠ¤íƒ€ì¼ */
    .drawflow .drawflow-node.Start {
      background-color: #e8f5e9;
      border-color: var(--secondary-color);
    }
    
    .drawflow .drawflow-node.End {
      background-color: #ffebee;
      border-color: #f44336;
    }
    
    .drawflow .drawflow-node.LLM {
      background-color: #e3f2fd;
    }
    
    .drawflow .drawflow-node.Tool {
      background-color: #fff3e0;
    }
    
    .drawflow .drawflow-node.Condition {
      background-color: #f3e5f5;
    }

    /* ì—°ê²°ì„  ìŠ¤íƒ€ì¼ */
    .drawflow .connection .main-path {
      stroke: var(--primary-color);
      stroke-width: 3px;
      fill: none;
      transition: stroke 0.3s ease;
    }
    
    .drawflow .connection:hover .main-path {
      stroke: var(--primary-dark);
      stroke-width: 4px;
    }
    
    .drawflow .connection.condition-connection .main-path {
      stroke: var(--secondary-color);
      stroke-dasharray: 5, 5;
    }
    
    .drawflow .connection.condition-connection:hover .main-path {
      stroke: var(--secondary-dark);
    }
    
    .drawflow .connection.selected .main-path {
      stroke: var(--primary-dark);
      stroke-width: 4px;
    }
    
    /* íˆ´íŒ ìŠ¤íƒ€ì¼ */
    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.8rem;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .modal-header h2 {
      margin: 0;
    }
    
    .close-button {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: var(--primary-color);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .connection.condition-connection .main-path {
      stroke: var(--branch-color, var(--secondary-color));
      stroke-dasharray: 5, 5;
    }

    .connection.condition-connection:hover .main-path {
      stroke: var(--branch-color, var(--secondary-dark));
      stroke-width: 4px;
    }

    .branch-item {
      margin-bottom: 8px;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* í‘¸í„° ìŠ¤íƒ€ì¼ */
    footer {
      background-color: #333;
      color: white;
      padding: 1rem 0;
      font-size: 0.9rem;
    }
    
    .footer-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }
    
    .footer-links {
      display: flex;
      gap: 1.5rem;
    }
    
    .footer-links a {
      color: #bbb;
      text-decoration: none;
      transition: color 0.3s;
    }
    
    .footer-links a:hover {
      color: white;
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 1200px) {
      .workspace-container {
        flex-direction: column;
        height: auto;
      }
      
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
      }
      
      .code-viewer {
        width: 100%;
        border-left: none;
        border-top: 1px solid var(--border-color);
      }
    }
    
    @media (max-width: 768px) {
      .header-container {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      
      .page-title {
        font-size: 1.2rem;
        flex-basis: 100%;
        text-align: center;
        margin: 0.5rem 0;
      }
      
      .footer-container {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
    }
  </style>
</head>

<body>
<div class="main-container">
  <!-- í—¤ë” -->
  <header>
    <div class="header-container">
      <a href="index.html" class="logo">
        <span class="logo-icon">ğŸ”„</span>
        LangGraph
      </a>
      
      <div class="page-title">ë…¸ë“œ ì—ë””í„°</div>
      
      <div class="nav-buttons">
        <a href="index.html" class="nav-button">
          <i>â†</i> ë©”ì¸ìœ¼ë¡œ
        </a>
        <a href="#" class="nav-button" id="saveWorkflowBtn">
          <i>ğŸ’¾</i> ì €ì¥
        </a>
        <div class="user-profile">
          <div class="user-avatar">G</div>
          <span>Guest</span>
        </div>
      </div>
    </div>
  </header>

  <div class="workspace-container">
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
      <h3>LangGraph ë¸”ë¡</h3>
      <div id="nodeButtons">
        <button data-type="Start" title="ê·¸ë˜í”„ ì‹œì‘ì ">Start</button>
        <button data-type="End" title="ê·¸ë˜í”„ ì¢…ë£Œì ">End</button>
        <button data-type="LLM" title="ì–¸ì–´ ëª¨ë¸ í˜¸ì¶œ">LLM</button>
        <button data-type="Tool" title="ì™¸ë¶€ ë„êµ¬ í˜¸ì¶œ">Tool</button>
        <button data-type="Condition" title="ì¡°ê±´ ë¶„ê¸°">Condition</button>
        <button data-type="Output" title="ê²°ê³¼ ì¶œë ¥">Output</button>
        <button data-type="Custom" title="ì‚¬ìš©ì ì •ì˜ ì½”ë“œ">Custom</button>
      </div>
      
      <div class="sidebar-actions" style="margin-top: 20px;">
        <button id="clearButton" style="background-color: #f44336; color: white;" title="ëª¨ë“  ë…¸ë“œ ì‚­ì œ">
          Clear All
        </button>
        <button id="importButton" style="background-color: #4CAF50; color: white; margin-top: 10px;" title="JSON íŒŒì¼ ê°€ì ¸ì˜¤ê¸°">
          Import JSON
        </button>
        <input type="file" id="importInput" style="display: none;" accept=".json">
        <button id="helpButton" style="background-color: #2196F3; color: white;" title="ë„ì›€ë§ ë³´ê¸°">
          ë„ì›€ë§
        </button>
      </div>
    </div>

    <!-- ì—ë””í„° -->
    <div class="editor-container">
      <div id="drawflow" class="editor-background"></div>
      
      <!-- íˆ´íŒ -->
      <div id="tooltip" class="tooltip"></div>
    </div>

    <!-- ì½”ë“œ ë·°ì–´ -->
    <div class="code-viewer">
      <div id="formPopup" class="code-viewer-edit">
        <h4>ë…¸ë“œ ì†ì„±</h4>
        <div id="formFields">
          <p>í¸ì§‘í•  ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
        </div>
      </div>

      <div class="code-viewer-content">
        <h3>ìƒì„±ëœ Python ì½”ë“œ</h3>
        <pre id="codeOutput" class="language-python"># ë¸”ë¡ì„ ì¶”ê°€í•´ë³´ì„¸ìš”</pre>
        <div class="code-viewer-actions">
          <button onclick="exportJson()">JSON ì €ì¥</button>
          <button onclick="copyCode()" class="secondary">ì½”ë“œ ë³µì‚¬</button>
          <button onclick="previewExecution()" class="primary" style="background-color: #9C27B0;">ì‹¤í–‰ ë¯¸ë¦¬ë³´ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- í‘¸í„° -->
  <footer>
    <div class="footer-container">
      <div class="copyright">
        &copy; 2025 LangGraph. All rights reserved.
      </div>
      <div class="footer-links">
        <a href="index.html">í™ˆ</a>
        <a href="#">ë¬¸ì„œ</a>
        <a href="#">íŠœí† ë¦¬ì–¼</a>
        <a href="#">API ì°¸ì¡°</a>
        <a href="#">ì»¤ë®¤ë‹ˆí‹°</a>
        <a href="#">í”¼ë“œë°±</a>
      </div>
    </div>
  </footer>
</div>

<!-- ëª¨ë‹¬ -->
<div id="helpModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>LangGraph ë…¸ë“œ ì—ë””í„° ë„ì›€ë§</h2>
      <button class="close-button" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <h3>ê¸°ë³¸ ì‚¬ìš©ë²•</h3>
      <p>1. ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ ì›í•˜ëŠ” ë…¸ë“œ ìœ í˜•ì„ í´ë¦­í•˜ì—¬ ìº”ë²„ìŠ¤ì— ì¶”ê°€í•©ë‹ˆë‹¤.</p>
      <p>2. ë…¸ë“œë¥¼ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ë©´ ì˜¤ë¥¸ìª½ íŒ¨ë„ì—ì„œ ì†ì„±ì„ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <p>3. ë…¸ë“œì˜ ì¶œë ¥ í•€ì—ì„œ ë‹¤ë¥¸ ë…¸ë“œì˜ ì…ë ¥ í•€ìœ¼ë¡œ ë“œë˜ê·¸í•˜ì—¬ ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <p>4. ì˜¤ë¥¸ìª½ íŒ¨ë„ í•˜ë‹¨ì—ì„œ ìƒì„±ëœ Python ì½”ë“œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      
      <h3>ë…¸ë“œ ìœ í˜•</h3>
      <ul>
        <li><strong>Start</strong>: ê·¸ë˜í”„ì˜ ì‹œì‘ì ì…ë‹ˆë‹¤.</li>
        <li><strong>End</strong>: ê·¸ë˜í”„ì˜ ì¢…ë£Œì ì…ë‹ˆë‹¤.</li>
        <li><strong>LLM</strong>: ì–¸ì–´ ëª¨ë¸ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.</li>
        <li><strong>Tool</strong>: ì™¸ë¶€ ë„êµ¬ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.</li>
        <li><strong>Condition</strong>: ì¡°ê±´ì— ë”°ë¼ íë¦„ì„ ë¶„ê¸°í•©ë‹ˆë‹¤.</li>
        <li><strong>Output</strong>: ê²°ê³¼ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.</li>
        <li><strong>Custom</strong>: ì‚¬ìš©ì ì •ì˜ Python ì½”ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.</li>
      </ul>
    </div>
  </div>
</div>

<!-- ìŠ¤í¬ë¦½íŠ¸ -->
<script src="https://cdn.jsdelivr.net/npm/drawflow/dist/drawflow.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>

<script>
// ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
const LangGraph = {
  editor: null,
  nodeCount: 0,
  selectedNodeId: null,
  
  // ë…¸ë“œ íƒ€ì…ë³„ ê¸°ë³¸ ë°ì´í„°
  nodeTemplates: {
    Start: { 
      label: 'Start',
      html: '<div class="title-box">Start</div><div class="description-box">ê·¸ë˜í”„ ì‹œì‘ì </div>',
      data: {}
    },
    End: { 
      label: 'End',
      html: '<div class="title-box">End</div><div class="description-box">ê·¸ë˜í”„ ì¢…ë£Œì </div>',
      data: {}
    },
    LLM: { 
      label: 'LLM',
      html: '<div class="title-box">LLM</div><div class="description-box">ì–¸ì–´ ëª¨ë¸ í˜¸ì¶œ</div>',
      data: { model: 'gpt-4', prompt: 'Your prompt here' }
    },
    Tool: { 
      label: 'Tool',
      html: '<div class="title-box">Tool</div><div class="description-box">ì™¸ë¶€ ë„êµ¬ í˜¸ì¶œ</div>',
      data: { tool_name: 'search_tool', description: 'Searches for information' }
    },
    Condition: { 
      label: 'Condition',
      html: '<div class="title-box">Condition</div><div class="description-box">ì¡°ê±´ ë¶„ê¸°</div>',
      data: { 
        condition: 'result.success == True',
        branches: ['true_branch', 'false_branch'] 
      }
    },
    Output: { 
      label: 'Output',
      html: '<div class="title-box">Output</div><div class="description-box">ê²°ê³¼ ì¶œë ¥</div>',
      data: {}
    },
    Custom: { 
      label: 'Custom',
      html: '<div class="title-box">Custom</div><div class="description-box">ì‚¬ìš©ì ì •ì˜ ì½”ë“œ</div>',
      data: { code: '# Write your own code here\n\n' }
    }
  },
  
  // ì´ˆê¸°í™”
  init: function() {
    // Drawflow ì—ë””í„° ì´ˆê¸°í™”
    this.editor = new Drawflow(document.getElementById('drawflow'));
    this.editor.start();
    this.editor.editor_mode = 'edit';
    this.editor.zoom_enable = true;
    this.editor.zoom_value = 1;
    this.editor.zoom_max = 1.6;
    this.editor.zoom_min = 0.5;
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    this.registerEventListeners();
    
    // ë…¸ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
    this.initNodeButtons();
    
    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë“±ë¡
    this.initKeyboardShortcuts();
    
    // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ í‘œì‹œ
    this.showToast('LangGraph ë…¸ë“œ ì—ë””í„°ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
  },
  
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  registerEventListeners: function() {
    // ë…¸ë“œ ê´€ë ¨ ì´ë²¤íŠ¸
    this.editor.on('nodeSelected', this.handleNodeSelected.bind(this));
    this.editor.on('nodeUnselected', this.handleNodeUnselected.bind(this));
    this.editor.on('nodeCreated', this.handleNodeCreated.bind(this));
    this.editor.on('nodeRemoved', this.handleNodeRemoved.bind(this));
    
    // ì—°ê²° ê´€ë ¨ ì´ë²¤íŠ¸
    this.editor.on('connectionCreated', this.handleConnectionCreated.bind(this));
    this.editor.on('connectionRemoved', this.handleConnectionRemoved.bind(this));
    
    // ì „ì²´ ê·¸ë˜í”„ ë³€ê²½ ì´ë²¤íŠ¸
    this.editor.on('zoom', this.handleZoom.bind(this));
  },
  
  // ë…¸ë“œ ë²„íŠ¼ ì´ˆê¸°í™”
  initNodeButtons: function() {
    const buttons = document.querySelectorAll('#nodeButtons button');
    buttons.forEach(button => {
      button.addEventListener('click', () => {
        this.addNode(button.dataset.type);
      });
      
      // íˆ´íŒ ì´ë²¤íŠ¸
      button.addEventListener('mouseover', (e) => {
        this.showTooltip(e.target, e.target.title);
      });
      
      button.addEventListener('mouseout', () => {
        this.hideTooltip();
      });
    });
    
    // Clear ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('clearButton').addEventListener('click', this.confirmClearAll.bind(this));
    // Import ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('importButton').addEventListener('click', () => {
      document.getElementById('importInput').click();
    });
    document.getElementById('helpButton').addEventListener('click', () => {
      LangGraph.openHelpModal();
    });
    document.getElementById('importInput').addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = (event) => {
          try {
            const jsonData = JSON.parse(event.target.result);
            this.editor.import(jsonData);
            this.updateCode();
            this.showToast('JSON íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤', 'success');
          } catch (error) {
            console.error('JSON ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
            this.showToast('JSON íŒŒì¼ ê°€ì ¸ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
          }
        };
        
        reader.readAsText(file);
      }
    });
  },
  
  // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì´ˆê¸°í™”
  initKeyboardShortcuts: function() {
    document.addEventListener('keydown', (e) => {
      // Delete í‚¤ë¡œ ì„ íƒëœ ë…¸ë“œ ì‚­ì œ
      if (e.key === 'Delete' && this.selectedNodeId !== null) {
        this.editor.removeNodeId(this.selectedNodeId);
        this.selectedNodeId = null;
        this.updateFormFields();
        this.updateCode();
        this.showToast('ë…¸ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
      }
      
      // Ctrl+Së¡œ JSON ì €ì¥
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        this.exportJson();
      }
      
      // Ctrl+Cë¡œ ì½”ë“œ ë³µì‚¬
      if (e.ctrlKey && e.key === 'c' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
        e.preventDefault();
        this.copyCode();
      }
      
      // F1 ë˜ëŠ” ?ë¡œ ë„ì›€ë§ í‘œì‹œ
      if (e.key === 'F1' || (e.shiftKey && e.key === '?')) {
        e.preventDefault();
        this.openHelpModal();
      }
    });
  },
  
  // ë…¸ë“œ ì¶”ê°€
  addNode: function(type) {
    try {
      // ë…¸ë“œ ìœ„ì¹˜ ê³„ì‚° (ê°€ì‹œ ì˜ì—­ ë‚´ì— ë°°ì¹˜)
      const editor = document.getElementById('drawflow');
      const posX = 100 + (this.nodeCount % 3) * 250;
      const posY = 100 + Math.floor(this.nodeCount / 3) * 150;
      
      const template = this.nodeTemplates[type];
      if (!template) {
        throw new Error(`ì•Œ ìˆ˜ ì—†ëŠ” ë…¸ë“œ ìœ í˜•: ${type}`);
      }
      
      // ë…¸ë“œ ID ìƒì„±
      const nodeId = this.editor.addNode(
        type,
        1, // ì…ë ¥ ì»¤ë„¥í„° ìˆ˜
        1, // ì¶œë ¥ ì»¤ë„¥í„° ìˆ˜ 
        posX,
        posY,
        type,
        { ...template.data, label: template.label },
        template.html
      );
      
      // ë…¸ë“œ í´ë˜ìŠ¤ ì¶”ê°€ (ìŠ¤íƒ€ì¼ë§ ìš©ë„)
      setTimeout(() => {
        const nodeElement = document.querySelector(`.drawflow-node[data-id="${nodeId}"]`);
        if (nodeElement) {
          nodeElement.classList.add(type);
        }
      }, 10);
      
      this.nodeCount++;
      this.updateCode();
      this.showToast(`${type} ë…¸ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
      
      return nodeId;
    } catch (error) {
      console.error('ë…¸ë“œ ì¶”ê°€ ì˜¤ë¥˜:', error);
      this.showToast('ë…¸ë“œë¥¼ ì¶”ê°€í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
      return null;
    }
  },
  
  // ë…¸ë“œ ì„ íƒ í•¸ë“¤ëŸ¬
  handleNodeSelected: function(nodeId) {
    this.selectedNodeId = nodeId;
    this.updateFormFields();
    
    // ì„ íƒëœ ë…¸ë“œë¡œ ìŠ¤í¬ë¡¤
    const nodeElement = document.querySelector(`.drawflow-node[data-id="${nodeId}"]`);
    if (nodeElement) {
      nodeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  },
  
  // ë…¸ë“œ ì„ íƒ í•´ì œ í•¸ë“¤ëŸ¬
  handleNodeUnselected: function() {
    this.selectedNodeId = null;
    this.updateFormFields();
  },
  
  // ë…¸ë“œ ìƒì„± í•¸ë“¤ëŸ¬
  handleNodeCreated: function() {
    this.updateCode();
  },
  
  // ë…¸ë“œ ì‚­ì œ í•¸ë“¤ëŸ¬
  handleNodeRemoved: function() {
    this.updateCode();
    if (this.selectedNodeId) {
      this.selectedNodeId = null;
      this.updateFormFields();
    }
  },
  
  // ì—°ê²° ìƒì„± í•¸ë“¤ëŸ¬
  handleConnectionCreated: function(connection) {
    // ì—°ê²° ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    this.updateConnectionStyle(connection);
    this.updateCode();
    this.showToast('ë…¸ë“œê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
    // ì—°ê²° ìœ íš¨ì„± ê²€ì‚¬ ì¶”ê°€
    const sourceNode = this.editor.getNodeFromId(connection.output_id);
    const targetNode = this.editor.getNodeFromId(connection.input_id);
    
    // End ë…¸ë“œëŠ” ì¶œë ¥ ì—°ê²°ì„ ê°€ì§ˆ ìˆ˜ ì—†ìŒ
    if (sourceNode?.name === 'End') {
      this.editor.removeSingleConnection(connection.output_id, connection.input_id, connection.output_class, connection.input_class);
      this.showToast('End ë…¸ë“œëŠ” ì¶œë ¥ ì—°ê²°ì„ ê°€ì§ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
      return;
    }
    
    // Start ë…¸ë“œëŠ” ì…ë ¥ ì—°ê²°ì„ ê°€ì§ˆ ìˆ˜ ì—†ìŒ
    if (targetNode?.name === 'Start') {
      this.editor.removeSingleConnection(connection.output_id, connection.input_id, connection.output_class, connection.input_class);
      this.showToast('Start ë…¸ë“œëŠ” ì…ë ¥ ì—°ê²°ì„ ê°€ì§ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
      return;
    }
    
    // ì—°ê²° ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    this.updateConnectionStyle(connection);
    this.updateCode();
    this.showToast('ë…¸ë“œê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
  },
  
  // ì—°ê²° ì‚­ì œ í•¸ë“¤ëŸ¬
  handleConnectionRemoved: function() {
    this.updateCode();
  },
  
  // ì¤Œ í•¸ë“¤ëŸ¬
  handleZoom: function() {
    // ì¤Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
  },
  
  // ì—°ê²° ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
  updateConnectionStyle: function(connection) {
    try {
      const { input_id, output_id } = connection;
      
      // ì¡°ê±´ ë…¸ë“œì—ì„œ ë‚˜ì˜¤ëŠ” ì—°ê²°ì„  ìŠ¤íƒ€ì¼ ì ìš©
      setTimeout(() => {
        const sourceNode = this.editor.getNodeFromId(output_id);
        const connections = document.querySelectorAll(`.connection.node_in_${input_id}.node_out_${output_id}`);
        
        connections.forEach(conn => {
          if (sourceNode?.name === 'Condition') {
            conn.classList.add('condition-connection');
            
            // ë¸Œëœì¹˜ë³„ ë‹¤ë¥¸ ìƒ‰ìƒ ìŠ¤íƒ€ì¼ ì ìš©
            const sourceNodeData = sourceNode.data;
            const branches = sourceNodeData?.branches || ['true_branch', 'false_branch'];
            const connectionIndex = Array.from(
              document.querySelectorAll(`.connection.node_out_${output_id}`)
            ).indexOf(conn);
            
            if (connectionIndex >= 0 && connectionIndex < branches.length) {
              // ë¸Œëœì¹˜ë³„ ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ ì ìš©
              conn.style.setProperty('--branch-color', this.getBranchColor(connectionIndex));
            }
          }
        });
      }, 100);
    } catch (error) {
      console.error('ì—°ê²° ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    }
  },

// ë¸Œëœì¹˜ë³„ ìƒ‰ìƒ ë°˜í™˜
getBranchColor: function(index) {
  const colors = [
    '#4CAF50', // ë…¹ìƒ‰ (true)  
    '#F44336', // ë¹¨ê°• (false)
    '#2196F3', // íŒŒë‘
    '#FF9800', // ì£¼í™©
    '#9C27B0', // ë³´ë¼
    '#00BCD4'  // ì²­ë¡
  ];
  return colors[index % colors.length];
},
  // í¼ í•„ë“œ ì—…ë°ì´íŠ¸
  updateFormFields: function() {
    const formFields = document.getElementById('formFields');
    
    if (!this.selectedNodeId) {
      formFields.innerHTML = '<p>í¸ì§‘í•  ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>';
      return;
    }
    
    try {
      const node = this.editor.getNodeFromId(this.selectedNodeId);
      if (!node) {
        throw new Error('ì„ íƒëœ ë…¸ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }
      
      const data = node.data || {};
      let fieldsHtml = `
        <label>
          ë¸”ë¡ ì´ë¦„
          <input id="nodeLabel" value="${data.label || node.name || ''}" placeholder="ë…¸ë“œ ì´ë¦„">
        </label>
      `;
      
      // ë…¸ë“œ íƒ€ì…ë³„ í•„ë“œ ì¶”ê°€
      switch (node.name) {
        case 'LLM':
          fieldsHtml += `
            <label>
              ëª¨ë¸
              <input id="nodeModel" value="${data.model || ''}" placeholder="ì˜ˆ: gpt-4">
            </label>
            <label>
              í”„ë¡¬í”„íŠ¸
              <textarea id="nodePrompt" placeholder="ì–¸ì–´ ëª¨ë¸ì— ì „ë‹¬í•  í”„ë¡¬í”„íŠ¸">${data.prompt || ''}</textarea>
            </label>
          `;
          break;
        case 'Tool':
          fieldsHtml += `
            <label>
              ë„êµ¬ ì´ë¦„
              <input id="nodeToolName" value="${data.tool_name || ''}" placeholder="ì˜ˆ: search_tool">
            </label>
            <label>
              ì„¤ëª…
              <textarea id="nodeDescription" placeholder="ë„êµ¬ì— ëŒ€í•œ ì„¤ëª…">${data.description || ''}</textarea>
            </label>
          `;
          break;
        case 'Condition':
          fieldsHtml += `
            <label>
              ì¡°ê±´ì‹
              <input id="nodeCondition" value="${data.condition || ''}" placeholder="ì˜ˆ: result.success == True">
            </label>
            <div id="branchContainer">
              <label>ë¸Œëœì¹˜</label>
              ${(data.branches || ['true_branch', 'false_branch']).map((branch, index) => `
                <div class="branch-item" style="display: flex; margin-bottom: 8px;">
                  <input id="branch_${index}" value="${branch}" placeholder="ë¸Œëœì¹˜ ì´ë¦„" style="flex: 1; margin-right: 8px;">
                  <button type="button" onclick="LangGraph.removeBranch(${index})" style="background: #f44336; color: white;">-</button>
                </div>
              `).join('')}
              <button type="button" onclick="LangGraph.addBranch()" style="width: 100%; margin-top: 8px; background: #4CAF50; color: white;">+ ë¸Œëœì¹˜ ì¶”ê°€</button>
            </div>
          `;
          break;
        case 'Custom':
          fieldsHtml += `
            <label>
              ì‚¬ìš©ì ì •ì˜ ì½”ë“œ
              <textarea id="nodeCode" placeholder="Python ì½”ë“œ ì‘ì„±" style="min-height: 120px;">${data.code || ''}</textarea>
            </label>
          `;
          break;
      }
      
      fieldsHtml += `<button onclick="LangGraph.saveNodeForm()">ë³€ê²½ì‚¬í•­ ì €ì¥</button>`;
      formFields.innerHTML = fieldsHtml;
    } catch (error) {
      console.error('í¼ í•„ë“œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
      formFields.innerHTML = '<p>ë…¸ë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>';
    }
  },
  
  // ë…¸ë“œ í¼ ì €ì¥
  saveNodeForm: function() {
    if (!this.selectedNodeId) {
      this.showToast('ì„ íƒëœ ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
      return;
    }
    
    try {
      // ê¸°ë³¸ í•„ë“œ
      const newData = {};
      const labelInput = document.getElementById('nodeLabel');
      if (labelInput) newData.label = labelInput.value || 'Unnamed Node'; // ê¸°ë³¸ê°’ ì œê³µ
      
      // ë…¸ë“œ ìœ í˜•ë³„ í•„ë“œ
      const node = this.editor.getNodeFromId(this.selectedNodeId);
      switch (node.name) {
        case 'LLM':
          const modelInput = document.getElementById('nodeModel');
          const promptInput = document.getElementById('nodePrompt');
          
          // í•„ìˆ˜ í•„ë“œ ê²€ì¦
          if (!modelInput?.value) {
            this.showToast('ëª¨ë¸ ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤', 'error');
            return;
          }
          
          newData.model = modelInput.value;
          newData.prompt = promptInput?.value || '';
          break;
          
        case 'Tool':
          const toolNameInput = document.getElementById('nodeToolName');
          
          // í•„ìˆ˜ í•„ë“œ ê²€ì¦
          if (!toolNameInput?.value) {
            this.showToast('ë„êµ¬ ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤', 'error');
            return;
          }
          
          newData.tool_name = toolNameInput.value;
          newData.description = document.getElementById('nodeDescription')?.value || '';
          break;
          
        case 'Condition':
          const conditionInput = document.getElementById('nodeCondition');
          if (conditionInput) newData.condition = conditionInput.value;
          
          // ë¸Œëœì¹˜ ë°ì´í„° ìˆ˜ì§‘
          const branches = [];
          let index = 0;
          let branchInput = document.getElementById(`branch_${index}`);
          while (branchInput) {
            if (branchInput.value.trim()) {
              branches.push(branchInput.value.trim());
            }
            index++;
            branchInput = document.getElementById(`branch_${index}`);
          }
          
          // ìµœì†Œ 2ê°œì˜ ë¸Œëœì¹˜ ë³´ì¥
          if (branches.length < 2) {
            branches.push('true_branch', 'false_branch');
          }
          
          newData.branches = branches;
          break;
          
        case 'Custom':
          const codeInput = document.getElementById('nodeCode');
          if (codeInput) newData.code = codeInput.value;
          break;
      }
      
      // ë…¸ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸
      this.editor.updateNodeDataFromId(this.selectedNodeId, newData);
      
      // ë…¸ë“œ UI ì—…ë°ì´íŠ¸
      this.updateNodeUI(this.selectedNodeId, newData);
      
      // ì½”ë“œ ì¬ìƒì„±
      this.updateCode();
      
      this.showToast('ë…¸ë“œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    } catch (error) {
      console.error('ë…¸ë“œ ì €ì¥ ì˜¤ë¥˜:', error);
      this.showToast('ë…¸ë“œ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
  },
  
   // ë…¸ë“œ UI ì—…ë°ì´íŠ¸
  updateNodeUI: function(nodeId, data) {
    try {
      const node = this.editor.getNodeFromId(nodeId);
      if (!node) return;
      
      // ë…¸ë“œ ë°ì´í„° ë° HTML ì—…ë°ì´íŠ¸
      if (data.label) {
        // HTML ë‚´ìš© ìƒì„±
        const html = `<div class="title-box">${data.label}</div><div class="description-box">${this.getNodeDescription(node.name, data)}</div>`;
        
        // ë…¸ë“œ HTML ì—…ë°ì´íŠ¸ (ë‚´ë¶€ ë°ì´í„°)
        node.html = html;
        
        // DOMì— ì§ì ‘ ë°˜ì˜ - ì •í™•í•œ ì…€ë ‰í„°ë¡œ ìš”ì†Œ ì°¾ê¸°
        const nodeElement = document.querySelector(`#node-${nodeId} .drawflow_content_node`);
        if (nodeElement) {
          nodeElement.innerHTML = html;
        } else {
          // ëŒ€ì²´ ì…€ë ‰í„° ì‹œë„
          const altNodeElement = document.querySelector(`.drawflow-node[data-id="${nodeId}"] .drawflow_content_node`);
          if (altNodeElement) {
            altNodeElement.innerHTML = html;
          } else {
            console.warn(`ë…¸ë“œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${nodeId}`);
          }
        }
      }
    } catch (error) {
      console.error('ë…¸ë“œ UI ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    }
  },
  
  // ë…¸ë“œ ì„¤ëª… ë°˜í™˜
  getNodeDescription: function(nodeType, data) {
    switch (nodeType) {
      case 'Start': return 'ê·¸ë˜í”„ ì‹œì‘ì ';
      case 'End': return 'ê·¸ë˜í”„ ì¢…ë£Œì ';
      case 'LLM': return data.model ? `Model: ${data.model}` : 'ì–¸ì–´ ëª¨ë¸ í˜¸ì¶œ';
      case 'Tool': return data.tool_name ? `Tool: ${data.tool_name}` : 'ì™¸ë¶€ ë„êµ¬ í˜¸ì¶œ';
      case 'Condition': return data.condition ? `If: ${data.condition}` : 'ì¡°ê±´ ë¶„ê¸°';
      case 'Output': return 'ê²°ê³¼ ì¶œë ¥';
      case 'Custom': return 'ì‚¬ìš©ì ì •ì˜ ì½”ë“œ';
      default: return '';
    }
  },
  

  // ë¸Œëœì¹˜ ì¶”ê°€
  addBranch: function() {
    const branchContainer = document.getElementById('branchContainer');
    if (!branchContainer) return;
    
    const branchItems = branchContainer.querySelectorAll('.branch-item');
    const newIndex = branchItems.length;
    
    const newBranchDiv = document.createElement('div');
    newBranchDiv.className = 'branch-item';
    newBranchDiv.style = 'display: flex; margin-bottom: 8px;';
    newBranchDiv.innerHTML = `
      <input id="branch_${newIndex}" placeholder="ë¸Œëœì¹˜ ì´ë¦„" style="flex: 1; margin-right: 8px;">
      <button type="button" onclick="LangGraph.removeBranch(${newIndex})" style="background: #f44336; color: white;">-</button>
    `;
    
    // ë²„íŠ¼ ì•ì— ì‚½ì…
    const addButton = branchContainer.querySelector('button[onclick="LangGraph.addBranch()"]');
    branchContainer.insertBefore(newBranchDiv, addButton);
  },

  // ë¸Œëœì¹˜ ì œê±°
  removeBranch: function(index) {
    const branchItem = document.getElementById(`branch_${index}`).parentNode;
    if (branchItem) {
      branchItem.remove();
      
      // ì¸ë±ìŠ¤ ì¬ì •ë ¬
      this.reindexBranches();
    }
  },

  // ë¸Œëœì¹˜ ì¸ë±ìŠ¤ ì¬ì •ë ¬
  reindexBranches: function() {
    const branchContainer = document.getElementById('branchContainer');
    if (!branchContainer) return;
    
    const branchItems = branchContainer.querySelectorAll('.branch-item');
    branchItems.forEach((item, i) => {
      const input = item.querySelector('input');
      const button = item.querySelector('button');
      
      input.id = `branch_${i}`;
      button.setAttribute('onclick', `LangGraph.removeBranch(${i})`);
    });
  },


  // ì½”ë“œ ìƒì„±
  updateCode: function() {
    try {
      const data = this.editor.export();
      if (!data.drawflow || !data.drawflow.Home || !data.drawflow.Home.data) {
        document.getElementById('codeOutput').textContent = '# ë¸”ë¡ì„ ì¶”ê°€í•´ë³´ì„¸ìš”';
        Prism.highlightElement(document.getElementById('codeOutput'));
        return;
      }
      
      const graph = data.drawflow.Home.data;
      
      // ë…¸ë“œ ê°„ ì—°ê²° ì •ë³´ ìˆ˜ì§‘
      const edges = Object.fromEntries(
        Object.entries(graph).map(([id, node]) => [
          id, 
          node.outputs?.output_1?.connections.map(c => c.node.toString()) || []
        ])
      );
      
      const visited = new Set();
      const codeLines = [
        '# LangGraph ìë™ ìƒì„± ì½”ë“œ',
        'from typing import Dict, List, Any',
        'from langchain_core.language_models import ChatOpenAI',
        'from langchain.tools import tool',
        'from langgraph.graph import StateGraph, END',
        '',
        '# ìƒíƒœ ì •ì˜',
        'class State(dict):',
        '    """ê·¸ë˜í”„ ìƒíƒœ ê°ì²´"""',
        '    def __init__(self, **kwargs):',
        '        super().__init__(**kwargs)',
        '        for key, value in kwargs.items():',
        '            setattr(self, key, value)',
        '',
        '# ê·¸ë˜í”„ ìƒì„±',
        'def create_graph():',
        '    """LangGraph ì›Œí¬í”Œë¡œìš° ìƒì„±"""',
        '    graph = StateGraph(State)',
        ''
      ];
      
      // ë…¸ë“œ ë°©ë¬¸ í•¨ìˆ˜
      const processNode = (nodeId) => {
        if (visited.has(nodeId)) return;
        visited.add(nodeId);
        
        const node = graph[nodeId];
        if (!node) return;
        
        const nodeName = (node.data.label || node.name).toLowerCase().replace(/\s+/g, '_');
        
        switch (node.name) {
          case 'Start':
            codeLines.push('    # ì‹œì‘ ë…¸ë“œ');
            codeLines.push(`    # ${node.data.label || 'Start'}`);
            break;
            
          case 'End':
            codeLines.push('    # ì¢…ë£Œ ë…¸ë“œ');
            codeLines.push(`    # ${node.data.label || 'End'}`);
            codeLines.push('    graph.add_node("end", END)');
            break;
            
          case 'LLM':
            codeLines.push(`    # LLM ë…¸ë“œ: ${node.data.label || 'LLM'}`);
            codeLines.push(`    def ${nodeName}_node(state):`);
            codeLines.push(`        """${node.data.label || 'LLM í˜¸ì¶œ'}"""`);
            codeLines.push(`        llm = ChatOpenAI(model='${node.data.model || 'gpt-4'}')`);
            codeLines.push(`        response = llm.invoke("${node.data.prompt?.replace(/"/g, '\\"') || 'Your prompt here'}")`);
            codeLines.push('        return {"response": response}');
            codeLines.push('');
            codeLines.push(`    graph.add_node("${nodeName}", ${nodeName}_node)`);
            break;
            
          case 'Tool':
            codeLines.push(`    # Tool ë…¸ë“œ: ${node.data.label || 'Tool'}`);
            codeLines.push('    @tool');
            codeLines.push(`    def ${node.data.tool_name || 'tool_function'}(query: str) -> str:`);
            codeLines.push(`        """${node.data.description || 'Tool description'}"""`);
            codeLines.push('        # ë„êµ¬ êµ¬í˜„');
            codeLines.push('        return f"Result for {query}"');
            codeLines.push('');
            codeLines.push(`    def ${nodeName}_node(state):`);
            codeLines.push(`        result = ${node.data.tool_name || 'tool_function'}(state.get("query", ""))`);
            codeLines.push('        return {"tool_result": result}');
            codeLines.push('');
            codeLines.push(`    graph.add_node("${nodeName}", ${nodeName}_node)`);
            break;
            
          case 'Condition':
            codeLines.push(`    # Condition ë…¸ë“œ: ${node.data.label || 'Condition'}`);
            codeLines.push(`    def ${nodeName}_router(state):`);
            codeLines.push(`        """${node.data.label || 'Condition'} ë¼ìš°í„°"""`);;
                      
            // ì¡°ê±´ì‹ ê¸°ë°˜ ë¶„ê¸° ì½”ë“œ ìƒì„±
            const branches = node.data.branches || ['true_branch', 'false_branch'];
            const nextNodes = edges[nodeId] || [];
            
            if (branches.length === 2 && nextNodes.length > 0) {
              // ê¸°ë³¸ true/false ë¶„ê¸°
              codeLines.push(`        if ${node.data.condition || 'True'}:`);
              codeLines.push(`            return "${branches[0]}"`);
              codeLines.push('        else:');
              codeLines.push(`            return "${branches[1]}"`);
            } else if (branches.length > 0 && nextNodes.length > 0) {
              // ë‹¤ì¤‘ ë¶„ê¸°
              codeLines.push('        # ì¡°ê±´ì— ë”°ë¼ ë¶„ê¸° ì„ íƒ');
              codeLines.push(`        condition = ${node.data.condition || 'None'}`);
              codeLines.push('        # ë¶„ê¸° ê²°ì • ë¡œì§');
              branches.forEach((branch, i) => {
                if (i === 0) {
                  codeLines.push(`        if condition == ${i}:`);
                } else if (i === branches.length - 1) {
                  codeLines.push('        else:');
                } else {
                  codeLines.push(`        elif condition == ${i}:`);
                }
                codeLines.push(`            return "${branch}"`);
              });
            } else {
              codeLines.push('        # ì—°ê²°ëœ ë¸Œëœì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤');
              codeLines.push('        return None');
            }
            
            codeLines.push('');
            codeLines.push(`    graph.add_conditional_edges(`);
            codeLines.push(`        "${nodeName}",`);
            codeLines.push(`        ${nodeName}_router,`);
            codeLines.push('        {');
            
            // ë¸Œëœì¹˜ë³„ ëª©ì ì§€ ë§¤í•‘ - ì‹¤ì œ ì—°ê²° ì •ë³´ì™€ ë§¤í•‘
            const branchMappings = [];
            branches.forEach((branch, idx) => {
              if (idx < nextNodes.length) {
                const targetNode = graph[nextNodes[idx]];
                if (targetNode) {
                  const targetName = (targetNode.data.label || targetNode.name).toLowerCase().replace(/\s+/g, '_');
                  branchMappings.push(`            "${branch}": "${targetName}"`);
                }
              }
            });
            
            codeLines.push(branchMappings.join(',\n') || '            # No connections');
            codeLines.push('        }');
            codeLines.push('    )');
            break;
            
          case 'Output':
            codeLines.push(`    # Output ë…¸ë“œ: ${node.data.label || 'Output'}`);
            codeLines.push(`    def ${nodeName}_node(state):`);
            codeLines.push('        """ê²°ê³¼ ì¶œë ¥"""');
            codeLines.push('        print(f"Output: {state.get(\'response\', \'No response\')}")')
            codeLines.push('        return state');
            codeLines.push('');
            codeLines.push(`    graph.add_node("${nodeName}", ${nodeName}_node)`);
            break;
            
          case 'Custom':
            codeLines.push(`    # Custom ë…¸ë“œ: ${node.data.label || 'Custom'}`);
            codeLines.push(`    def ${nodeName}_node(state):`);
            const customCode = node.data.code?.trim() || '# Custom code';
            // ë“¤ì—¬ì“°ê¸° ì²˜ë¦¬
            customCode.split('\n').forEach(line => {
              codeLines.push(`        ${line}`);
            });
            codeLines.push('        return state');
            codeLines.push('');
            codeLines.push(`    graph.add_node("${nodeName}", ${nodeName}_node)`);
            break;
        }
        
        // ë‹¤ìŒ ë…¸ë“œ ì²˜ë¦¬
        edges[nodeId].forEach(nextNodeId => {
          processNode(nextNodeId);
        });
      };
      
      // ì‹œì‘ ë…¸ë“œ ì°¾ê¸° ë° ì²˜ë¦¬
      let startNode = null;
      Object.entries(graph).forEach(([id, node]) => {
        if (node.name === 'Start') {
          startNode = id;
        }
      });
      
      // ì‹œì‘ ë…¸ë“œë¶€í„° DFS ìˆ˜í–‰
      if (startNode) {
        processNode(startNode);
      } else {
        // ì‹œì‘ ë…¸ë“œê°€ ì—†ìœ¼ë©´ ëª¨ë“  ë…¸ë“œ ì²˜ë¦¬
        Object.keys(graph).forEach(processNode);
      }
      
      // ì—£ì§€ ì—°ê²° ì½”ë“œ ìƒì„±
      codeLines.push('    # ë…¸ë“œ ì—°ê²°');
      Object.entries(edges).forEach(([nodeId, targets]) => {
        const sourceNode = graph[nodeId];
        if (!sourceNode) return;
        
        const sourceName = (sourceNode.data.label || sourceNode.name).toLowerCase().replace(/\s+/g, '_');
        
        targets.forEach(targetId => {
          const targetNode = graph[targetId];
          if (!targetNode) return;
          
          const targetName = (targetNode.data.label || targetNode.name).toLowerCase().replace(/\s+/g, '_');
          
          // Condition ë…¸ë“œëŠ” ì´ë¯¸ ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ê±´ë„ˆëœ€
          if (sourceNode.name !== 'Condition') {
            codeLines.push(`    graph.add_edge("${sourceName}", "${targetName}")`);
          }
        });
      });
      
      // ê·¸ë˜í”„ ì‹¤í–‰ ì½”ë“œ
      codeLines.push('');
      codeLines.push('    return graph');
      codeLines.push('');
      codeLines.push('# ê·¸ë˜í”„ ì‹¤í–‰');
      codeLines.push('if __name__ == "__main__":');
      codeLines.push('    graph = create_graph()');
      codeLines.push('    # ì´ˆê¸° ìƒíƒœ ì„¤ì •');
      codeLines.push('    initial_state = State(query="í•œêµ­ì˜ ìˆ˜ë„ëŠ” ì–´ë””ì¸ê°€ìš”?")');
      codeLines.push('    # ê·¸ë˜í”„ ì‹¤í–‰');
      codeLines.push('    graph.invoke(initial_state)');
      
      // ì½”ë“œ í‘œì‹œ
      const finalCode = codeLines.join('\n');
      document.getElementById('codeOutput').textContent = finalCode;
      Prism.highlightElement(document.getElementById('codeOutput'));
    } catch (error) {
      console.error('ì½”ë“œ ìƒì„± ì˜¤ë¥˜:', error);
      document.getElementById('codeOutput').textContent = `# ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
      Prism.highlightElement(document.getElementById('codeOutput'));
      this.showToast('ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
  },
  
  // JSON ë‚´ë³´ë‚´ê¸°
  exportJson: function() {
    try {
      const dataStr = JSON.stringify(this.editor.export(), null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'langgraph_flow.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      this.showToast('JSON íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    } catch (error) {
      console.error('JSON ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
      this.showToast('JSON ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
  },
  
  // ì½”ë“œ ë³µì‚¬
  copyCode: function() {
    try {
      const codeOutput = document.getElementById('codeOutput');
      const tempTextarea = document.createElement('textarea');
      tempTextarea.value = codeOutput.textContent;
      document.body.appendChild(tempTextarea);
      tempTextarea.select();
      document.execCommand('copy');
      document.body.removeChild(tempTextarea);
      
      this.showToast('ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    } catch (error) {
      console.error('ì½”ë“œ ë³µì‚¬ ì˜¤ë¥˜:', error);
      this.showToast('ì½”ë“œ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
  },
  
  // ëª¨ë“  ë…¸ë“œ ì‚­ì œ í™•ì¸
  confirmClearAll: function() {
    if (confirm('ëª¨ë“  ë…¸ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      this.editor.clear();
      this.nodeCount = 0;
      this.selectedNodeId = null;
      this.updateFormFields();
      this.updateCode();
      this.showToast('ëª¨ë“  ë…¸ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
    }
  },
  
  // íˆ´íŒ í‘œì‹œ
  showTooltip: function(element, text) {
    const tooltip = document.getElementById('tooltip');
    const rect = element.getBoundingClientRect();
    
    tooltip.textContent = text;
    tooltip.style.left = `${rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
    tooltip.style.top = `${rect.bottom + 5}px`;
    tooltip.style.opacity = '1';
  },
  
  // íˆ´íŒ ìˆ¨ê¸°ê¸°
  hideTooltip: function() {
    const tooltip = document.getElementById('tooltip');
    tooltip.style.opacity = '0';
  },
  
  // ë„ì›€ë§ ëª¨ë‹¬ ì—´ê¸°
  openHelpModal: function() {
    const modal = document.getElementById('helpModal');
    modal.style.display = 'flex';
  },
  
  // ëª¨ë‹¬ ë‹«ê¸°
  closeModal: function() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
      modal.style.display = 'none';
    });
  },
  
  //ë¯¸ë¦¬ë³´ê¸° ì‹¤í–‰
  previewExecution: function() {
  const data = this.editor.export();
  if (!data.drawflow?.Home?.data) {
    this.showToast('ë¯¸ë¦¬ë³´ê¸°í•  ê·¸ë˜í”„ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  const graph = data.drawflow.Home.data;
  
  // ì‹œì‘ ë…¸ë“œ ì°¾ê¸°
  let startNodeId = null;
  Object.entries(graph).forEach(([id, node]) => {
    if (node.name === 'Start') {
      startNodeId = id;
    }
  });
  
  if (!startNodeId) {
    this.showToast('ì‹œì‘ ë…¸ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤', 'error');
    return;
  }
  
  // ì‹¤í–‰ íë¦„ ê²°ê³¼ë¥¼ ë³´ì—¬ì£¼ëŠ” ëª¨ë‹¬ ìƒì„±
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.display = 'flex';
  
  const modalContent = document.createElement('div');
  modalContent.className = 'modal-content';
  modalContent.style.width = '80%';
  modalContent.style.maxWidth = '800px';
  
  const header = document.createElement('div');
  header.className = 'modal-header';
  header.innerHTML = `
    <h2>ì‹¤í–‰ íë¦„ ë¯¸ë¦¬ë³´ê¸°</h2>
    <button class="close-button" onclick="LangGraph.closeModal()">&times;</button>
  `;
  
  const body = document.createElement('div');
  body.className = 'modal-body';
  body.innerHTML = '<div id="execution-preview" style="max-height: 400px; overflow-y: auto;"></div>';
  
  modalContent.appendChild(header);
  modalContent.appendChild(body);
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // ì‹¤í–‰ íë¦„ ì‹œë®¬ë ˆì´ì…˜ ë° í‘œì‹œ
  this.simulateExecution(startNodeId, graph, document.getElementById('execution-preview'));
},

simulateExecution: function(nodeId, graph, container) {
  const visited = new Set();
  const state = { query: "í•œêµ­ì˜ ìˆ˜ë„ëŠ” ì–´ë””ì¸ê°€ìš”?" };
  
  const simulateNode = (id, depth = 0) => {
    if (visited.has(id)) return;
    visited.add(id);
    
    const node = graph[id];
    if (!node) return;
    
    const nodeDiv = document.createElement('div');
    nodeDiv.style.marginLeft = `${depth * 20}px`;
    nodeDiv.style.padding = '10px';
    nodeDiv.style.marginBottom = '10px';
    nodeDiv.style.borderLeft = '2px solid #2196F3';
    nodeDiv.style.backgroundColor = '#f5f5f5';
    nodeDiv.style.borderRadius = '4px';
    
    // ë…¸ë“œ ë©”íƒ€ë°ì´í„° í‘œì‹œ
    const nodeLabel = node.data.label || node.name;
    nodeDiv.innerHTML = `<h4 style="margin: 0 0 10px 0;">${nodeLabel} (${node.name})</h4>`;
    
    // ë…¸ë“œ ìœ í˜•ë³„ ë™ì‘ ì‹œë®¬ë ˆì´ì…˜
    switch (node.name) {
      case 'Start':
        nodeDiv.innerHTML += `<p>ì´ˆê¸° ìƒíƒœ: ${JSON.stringify(state)}</p>`;
        break;
        
      case 'End':
        nodeDiv.innerHTML += `<p>ì‹¤í–‰ ì¢…ë£Œ, ìµœì¢… ìƒíƒœ: ${JSON.stringify(state)}</p>`;
        break;
        
      case 'LLM':
        const response = 'ì´ëŠ” LLM ì‘ë‹µì˜ ì‹œë®¬ë ˆì´ì…˜ì…ë‹ˆë‹¤. ì‹¤ì œ ì‘ë‹µì€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
        state.response = response;
        nodeDiv.innerHTML += `<p>í”„ë¡¬í”„íŠ¸: ${node.data.prompt || 'ì§€ì •ë˜ì§€ ì•ŠìŒ'}</p>`;
        nodeDiv.innerHTML += `<p>ì‘ë‹µ: ${response}</p>`;
        break;
        
      case 'Tool':
        const result = `${node.data.tool_name || 'tool'} ì‹¤í–‰ ê²°ê³¼`;
        state.tool_result = result;
        nodeDiv.innerHTML += `<p>ë„êµ¬: ${node.data.tool_name || 'ì§€ì •ë˜ì§€ ì•ŠìŒ'}</p>`;
        nodeDiv.innerHTML += `<p>ê²°ê³¼: ${result}</p>`;
        break;
        
      case 'Condition':
        const condition = node.data.condition || 'True';
        const branches = node.data.branches || ['true_branch', 'false_branch'];
        nodeDiv.innerHTML += `<p>ì¡°ê±´ì‹: ${condition}</p>`;
        nodeDiv.innerHTML += `<p>ì„ íƒëœ ë¸Œëœì¹˜: ${branches[0]}</p>`;
        break;
        
      case 'Output':
        nodeDiv.innerHTML += `<p>ì¶œë ¥: ${state.response || state.tool_result || 'ê²°ê³¼ ì—†ìŒ'}</p>`;
        break;
        
      case 'Custom':
        nodeDiv.innerHTML += `<p>ì‚¬ìš©ì ì •ì˜ ì½”ë“œ ì‹¤í–‰</p>`;
        nodeDiv.innerHTML += `<pre style="background: #f0f0f0; padding: 5px;">${node.data.code || '# ì½”ë“œ ì—†ìŒ'}</pre>`;
        break;
    }
    
    container.appendChild(nodeDiv);
    
    // ë‹¤ìŒ ë…¸ë“œ ì²˜ë¦¬
    const outputs = node.outputs?.output_1?.connections || [];
    
    // Condition ë…¸ë“œì˜ ê²½ìš° ì²« ë²ˆì§¸ ë¶„ê¸°ë§Œ ì‹œë®¬ë ˆì´ì…˜
    if (node.name === 'Condition' && outputs.length > 0) {
      const nextNode = outputs[0].node;
      simulateNode(nextNode, depth + 1);
    } else {
      // ì¼ë°˜ ë…¸ë“œëŠ” ëª¨ë“  ì—°ê²° ì‹œë®¬ë ˆì´ì…˜
      outputs.forEach(conn => {
        simulateNode(conn.node, depth + 1);
      });
    }
  };
  
  simulateNode(nodeId);
},


  // ì•Œë¦¼ í‘œì‹œ
  showToast: function(message, type = 'info') {
    const bgColors = {
      success: 'linear-gradient(to right, #00b09b, #96c93d)',
      error: 'linear-gradient(to right, #ff5f6d, #ffc371)',
      info: 'linear-gradient(to right, #2193b0, #6dd5ed)',
      warning: 'linear-gradient(to right, #f2994a, #f2c94c)'
    };
    
    Toastify({
      text: message,
      duration: 3000,
      gravity: 'bottom',
      position: 'right',
      backgroundColor: bgColors[type] || bgColors.info,
      stopOnFocus: true
    }).showToast();
  }
};

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
  LangGraph.init();
  
  // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
  window.addEventListener('click', (e) => {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });
});


// ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ
window.exportJson = function() { LangGraph.exportJson(); };
window.copyCode = function() { LangGraph.copyCode(); };
window.closeModal = function() { LangGraph.closeModal(); };
window.previewExecution = function() {LangGraph.previewExecution(); };


</script>

</body>
</html>